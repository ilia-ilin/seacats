<!-- message.html -->
{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h3>Сообщения с <a href="{{ url_for('profile', user_id=receiver.id) }}">{{ receiver.username }}</a></h3>

    <!-- Информация о предложении -->
    {% if offer %}
    <div class="card-header bg-custom text-white rounded-top-4">
        <h4>Предложение:</h4>
        <p><strong><a href="{{ url_for('offer', offer_id=offer.id) }}">{{ offer.title }}</a></strong></p>
    </div>
    {% endif %}

    <div class="message-container">
        <div class="messages">
            {% for msg in messages %}
                <div class="message border p-3 mb-2 rounded">
                    <strong><a href="{{ url_for('profile', user_id=msg.sender.id) }}">{{ msg.sender.username }}</a>:</strong>
                    <p>{{ msg.text }}</p>
                    <small class="text-muted">{{ msg.timestamp }}</small>
                </div>
            {% endfor %}
        </div>
    </div>

    <form method="POST" id="message-form">
        <div class="form-group">
            <label for="message-text">Ваше сообщение:</label>
            <textarea class="form-control" id="message-text" name="text" rows="3" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary mt-2">Отправить</button>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Автофокус на поле ввода
        const messageInput = document.getElementById('message-text');
        if(messageInput) {
            messageInput.focus();
        }

        // Автопрокрутка
        const messagesDiv = document.querySelector('.message-container');
        if(messagesDiv) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Обработчик ENTER
        document.getElementById("message-text").addEventListener("keydown", function(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault();
                document.getElementById("message-form").submit();
            }
        });
    });
</script>
{% endblock %}
